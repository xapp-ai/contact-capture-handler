name: Changelog PR

on:
  release:
    types: [published]

jobs:
  changelog-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: 24.13.0

      - name: Get release version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: npm version ${{ steps.version.outputs.version }} --no-git-tag-version

      - name: Generate changelog
        run: npx conventional-changelog -p angular -i CHANGELOG.md -s -r 0

      - name: Create PR
        uses: peter-evans/create-pull-request@v8
        with:
          branch: chore/release-${{ github.ref_name }}
          title: "chore(release): ${{ github.ref_name }}"
          commit-message: "chore(release): ${{ steps.version.outputs.version }} [skip ci]"
          body: |
            Automated release PR for ${{ github.ref_name }}

            - Updates `package.json` version to ${{ steps.version.outputs.version }}
            - Updates `CHANGELOG.md`
          labels: release
          delete-branch: true
